{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Update Firmware</h2>

    <div class="alert alert-info text-center" role="alert">
        Please select the firmware file to upload (.bin, .ini, .cpp)
    </div>

    <form id="uploadForm" method="POST" action="{% url 'upload_firmware' %}" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <label for="firmware" class="form-label">Choose firmware file:</label>
            <input type="file" id="firmware" name="firmware" accept=".bin,.ini,.cpp" required aria-label="Firmware File"
                class="form-control">
        </div>
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg">Upload Firmware</button>
        </div>
    </form>

    <div class="progress mb-4" style="height: 30px;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100">0%</div>
    </div>

    <div class="info text-center mb-4"></div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Send Message to ESP</h5>
            <div class="mb-3">
                <label for="message" class="form-label">Message:</label>
                <input type="text" id="message" class="form-control" placeholder="Type your message">
            </div>
            <div class="d-grid gap-2">
                <button onclick="sendMessage()" class="btn btn-secondary">Send</button>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Messages:</h5>
            <div id="messages" class="overflow-auto" style="max-height: 200px;">
                <p>No messages yet...</p>
            </div>
        </div>
    </div>

    <script>
         const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const webSocketUrl = `${protocol}://${window.location.host}/ws/goo/`;
    const socket = new WebSocket(webSocketUrl);

    socket.onopen = function() {
        console.log("Connected to WebSocket");
        document.getElementById('messages').innerHTML += '<p>Connected</p>';
    };

    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        let messages = document.getElementById('messages');
        let messageElement = document.createElement('p');
        messageElement.textContent = JSON.stringify(message);
        messages.appendChild(messageElement);
    };

    socket.onclose = function() {
        console.log("WebSocket closed");
        document.getElementById('messages').innerHTML += '<p>Disconnected</p>';
    };
    const USER_ID = {{ user.id|default:"null" }};  // Asigură-te că variabila este definită cu ID-ul utilizatorului

    // Funcția care trimite mesaje WebSocket
    function sendMessage() {
        let input = document.getElementById('message');
        const messageContent = input.value.split(' ');  // Ex: "get test_mode"

        if (messageContent.length === 2) {
            const action = messageContent[0];  // Ex: "get" sau "set"
            const attribute_name = messageContent[1];  // Ex: "test_mode"

            // Trimitem comanda către WebSocket
            socket.send(JSON.stringify({
                'action': action,
                'attribute_name': attribute_name,
                'user_id': USER_ID  // Asigură-te că USER_ID este corect definit
            }));
        } else if (messageContent.length === 3 && messageContent[0] === "set") {
            const action = messageContent[0];  // Ex: "set"
            const attribute_name = messageContent[1];  // Ex: "test_mode"
            const value = messageContent[2];  // Ex: "True"

            // Trimitem comanda de setare către WebSocket
            socket.send(JSON.stringify({
                'action': action,
                'attribute_name': attribute_name,
                'value': value,
                'user_id': USER_ID  // Asigură-te că USER_ID este corect definit
            }));
        }

        input.value = '';  // Curățăm câmpul după trimitere
    }

    </script>

    {% endblock %}